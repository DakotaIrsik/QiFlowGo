name: Discord Commit Notification

on:
  push:
    branches:
      - main
      - develop

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_COMMIT_CHANNEL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Discord webhook URL not configured. Skipping notification."
            exit 0
          fi

          # Extract commit information
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          BRANCH_NAME="${{ github.ref_name }}"
          REPO_NAME="${{ github.repository }}"

          # Escape special characters in commit message for JSON
          COMMIT_MESSAGE_ESCAPED=$(echo "$COMMIT_MESSAGE" | jq -Rs .)

          # Create Discord webhook payload
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "📝 New Commit",
              "description": $COMMIT_MESSAGE_ESCAPED,
              "color": 5793266,
              "fields": [
                {
                  "name": "Repository",
                  "value": "$REPO_NAME",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "$BRANCH_NAME",
                  "inline": true
                },
                {
                  "name": "Author",
                  "value": "$COMMIT_AUTHOR",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[\`${COMMIT_SHA:0:7}\`]($COMMIT_URL)",
                  "inline": true
                }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
              "footer": {
                "text": "QiFlow Control Center"
              }
            }],
            "username": "QiFlow Git Bot"
          }
          EOF
          )

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK"

          echo "Discord notification sent successfully"
