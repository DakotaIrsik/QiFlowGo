name: Discord Commit Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send commit notification
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_COMMIT_CHANNEL }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          COMMIT_SHA: ${{ github.sha }}
          BRANCH: ${{ github.ref_name }}
        run: |
          # Escape quotes and newlines in commit message for JSON
          ESCAPED_MSG=$(echo "$COMMIT_MSG" | jq -Rs .)
          ESCAPED_AUTHOR=$(echo "$COMMIT_AUTHOR" | jq -Rs .)
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)

          curl -X POST "https://discord.com/api/v10/channels/$DISCORD_CHANNEL_ID/messages" \
            -H "Authorization: Bot $DISCORD_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üìù New Commit to QiFlowGo",
                "description": '"$ESCAPED_MSG"',
                "color": 5814783,
                "fields": [
                  {"name": "Author", "value": '"$ESCAPED_AUTHOR"', "inline": true},
                  {"name": "Branch", "value": "'"$BRANCH"'", "inline": true},
                  {"name": "Commit", "value": "['"$SHORT_SHA"']('"$COMMIT_URL"')", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'
